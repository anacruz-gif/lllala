<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Industrial ESP32</title>
    <style>
        /* =========================================
           ESTILOS (CSS)
           ========================================= */
        :root {
            /* COLOR DE FONDO ROSA SOLICITADO */
            --fondo-pantalla: #ffb6c1; 
            
            /* Colores Industriales para los instrumentos */
            --panel-fondo: #1e1e1e;
            --texto-principal: #ffffff;
            --led-apagado: #333333;
            --led-verde: #00ff00;
            --led-rojo: #ff0000;
            --borde-azul: #00d9ff;
            --borde-naranja: #ff9800;
        }

        body {
            background-color: var(--fondo-pantalla);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            text-align: center;
            color: #333;
        }

        h1 {
            color: #b71c1c; /* Rojo oscuro para contraste */
            text-transform: uppercase;
            margin-bottom: 5px;
            font-size: 24px;
        }

        h2 {
            font-size: 16px;
            color: #555;
            margin-top: 0;
            margin-bottom: 30px;
        }

        /* Contenedor Flex para los paneles */
        .dashboard {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }

        /* Tarjetas de Control (Estilo Industrial Oscuro) */
        .panel {
            background-color: var(--panel-fondo);
            border-radius: 15px;
            padding: 25px;
            width: 300px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            color: var(--texto-principal);
            border-left: 5px solid; /* Borde de color para identificar */
            position: relative;
        }

        .borde-azul { border-left-color: var(--borde-azul); }
        .borde-naranja { border-left-color: var(--borde-naranja); }

        .panel-titulo {
            font-size: 18px;
            font-weight: bold;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
            margin-bottom: 20px;
            text-transform: uppercase;
        }

        /* Estilos de los LEDs */
        .led-container {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }

        .led-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .led {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--led-apagado);
            border: 2px solid #555;
            box-shadow: inset 0 0 10px #000;
            transition: all 0.3s;
        }

        .led-label {
            margin-top: 8px;
            font-size: 12px;
            color: #aaa;
        }

        /* Clases para encender */
        .on-green {
            background-color: var(--led-verde);
            box-shadow: 0 0 20px var(--led-verde), inset 0 0 5px #fff;
            border-color: #fff;
        }

        .on-red {
            background-color: var(--led-rojo);
            box-shadow: 0 0 20px var(--led-rojo), inset 0 0 5px #fff;
            border-color: #fff;
        }

        /* Texto de estado grande */
        .estado-texto {
            background: #000;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 16px;
            color: #ff4444; /* Default rojo */
        }

        /* Bot贸n de Bluetooth */
        .btn-connect {
            background: #d81b60; /* Rosa oscuro fuerte */
            color: white;
            font-size: 18px;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 40px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: transform 0.2s;
            font-weight: bold;
        }

        .btn-connect:hover {
            transform: scale(1.05);
            background: #ad1457;
        }

        .status-bar {
            margin-top: 10px;
            font-weight: bold;
            color: #333;
        }

        /* Historial tipo consola */
        .console {
            background: #000;
            color: #0f0;
            font-family: monospace;
            text-align: left;
            padding: 15px;
            margin: 30px auto;
            max-width: 600px;
            height: 100px;
            overflow-y: auto;
            border-radius: 8px;
            border: 2px solid #444;
            font-size: 12px;
        }

    </style>
</head>
<body>

    <h1>Tecnol贸gico Universitario Vida Nueva</h1>
    <h2>Integrantes: William Palllo, Christopher Nacimba</h2>

    <div class="dashboard">

        <div class="panel borde-azul">
            <div class="panel-titulo">ElectroV谩lvula</div>
            
            <div class="led-container">
                <div class="led-wrapper">
                    <div id="led-valvula-on" class="led"></div>
                    <span class="led-label">ABIERTA</span>
                </div>
                <div class="led-wrapper">
                    <div id="led-valvula-off" class="led on-red"></div> <span class="led-label">CERRADA</span>
                </div>
            </div>

            <div id="txt-valvula" class="estado-texto">ESTADO: OFF</div>
        </div>

        <div class="panel borde-naranja">
            <div class="panel-titulo">Sensor de Boya</div>
            
            <div class="led-container">
                <div class="led-wrapper">
                    <div id="led-boya-on" class="led"></div>
                    <span class="led-label">LLENO (ALTO)</span>
                </div>
                <div class="led-wrapper">
                    <div id="led-boya-off" class="led on-red"></div> <span class="led-label">VACO (BAJO)</span>
                </div>
            </div>

            <div id="txt-boya" class="estado-texto">ESTADO: VACO</div>
        </div>

    </div>

    <button class="btn-connect" onclick="conectarBluetooth()"> CONECTAR AL ESP32</button>
    <div id="status-msg" class="status-bar">Desconectado</div>

    <div class="console" id="console-log">
        > Sistema listo...<br>
        > Esperando conexi贸n Bluetooth...
    </div>

    <script>
        /* =========================================
           JAVASCRIPT (LGICA BLUETOOTH)
           ========================================= */

        // UUIDs (Estos n煤meros deben coincidir EXACTAMENTE con tu c贸digo Arduino)
        const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
        const CHAR_UUID_RX = "6e400003-b5a3-f393-e0a9-e50e24dcca9e"; // Usamos TX del ESP32

        // Variables Globales
        let device, characteristic;

        // Referencias al DOM (V谩lvula)
        const ledValOn = document.getElementById("led-valvula-on");
        const ledValOff = document.getElementById("led-valvula-off");
        const txtVal = document.getElementById("txt-valvula");

        // Referencias al DOM (Boya)
        const ledBoyaOn = document.getElementById("led-boya-on");
        const ledBoyaOff = document.getElementById("led-boya-off");
        const txtBoya = document.getElementById("txt-boya");

        const statusMsg = document.getElementById("status-msg");
        const consoleLog = document.getElementById("console-log");

        // --- FUNCIN PRINCIPAL DE CONEXIN ---
        async function conectarBluetooth() {
            // Verificar si el navegador soporta Bluetooth
            if (!navigator.bluetooth) {
                alert("隆Tu navegador no soporta Bluetooth Web! Usa Chrome en PC o Android.");
                return;
            }

            try {
                log("Iniciando b煤squeda de dispositivos...");
                
                // 1. Solicitar dispositivo
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'ESP32_VALVULA' }], // Busca este nombre exacto
                    optionalServices: [SERVICE_UUID]
                });

                // 2. Conectar al servidor GATT
                log("Conectando al servidor GATT...");
                const server = await device.gatt.connect();

                // 3. Obtener Servicio
                log("Obteniendo servicio...");
                const service = await server.getPrimaryService(SERVICE_UUID);

                // 4. Obtener Caracter铆stica (Lectura/Notificaci贸n)
                log("Obteniendo caracter铆stica...");
                characteristic = await service.getCharacteristic(CHAR_UUID_RX);

                // 5. Iniciar Notificaciones
                await characteristic.startNotifications();
                
                // 6. Escuchar cambios
                characteristic.addEventListener('characteristicvaluechanged', recibirDatos);

                // 7. Actualizar UI
                statusMsg.innerText = "Conectado a: " + device.name;
                statusMsg.style.color = "green";
                log("隆Conexi贸n Exitosa!");

                // Manejar desconexi贸n
                device.addEventListener('gattserverdisconnected', () => {
                    statusMsg.innerText = "Desconectado";
                    statusMsg.style.color = "red";
                    log("Dispositivo desconectado.");
                    alert("Se perdi贸 la conexi贸n con el ESP32");
                });

            } catch (error) {
                console.error(error);
                log("Error: " + error);
                alert("No se pudo conectar. Revisa la consola (F12) para m谩s detalles.");
            }
        }

        // --- FUNCIN PARA PROCESAR DATOS DEL ESP32 ---
        function recibirDatos(event) {
            // Convertir los datos crudos a texto
            const decoder = new TextDecoder();
            const mensaje = decoder.decode(event.target.value).trim();
            
            log("Recibido: " + mensaje);

            // LOGICA DE CONTROL
            // Espera: VALVULA:ON, VALVULA:OFF, BOYA:ON, BOYA:OFF

            if (mensaje === "VALVULA:ON") {
                toggleValvula(true);
            } 
            else if (mensaje === "VALVULA:OFF") {
                toggleValvula(false);
            }
            else if (mensaje === "BOYA:ON") {
                toggleBoya(true);
            }
            else if (mensaje === "BOYA:OFF") {
                toggleBoya(false);
            }
        }

        // --- ACTUALIZAR VLVULA ---
        function toggleValvula(estado) {
            if (estado) { // ON
                ledValOn.classList.add("on-green");
                ledValOff.classList.remove("on-red");
                txtVal.innerText = "ESTADO: ABIERTA";
                txtVal.style.color = "#00ff00";
            } else { // OFF
                ledValOn.classList.remove("on-green");
                ledValOff.classList.add("on-red");
                txtVal.innerText = "ESTADO: CERRADA";
                txtVal.style.color = "#ff4444";
            }
        }

        // --- ACTUALIZAR BOYA ---
        function toggleBoya(estado) {
            if (estado) { // ON (Nivel Alto)
                ledBoyaOn.classList.add("on-green");
                ledBoyaOff.classList.remove("on-red");
                txtBoya.innerText = "ESTADO: LLENO";
                txtBoya.style.color = "#00ff00";
            } else { // OFF (Nivel Bajo)
                ledBoyaOn.classList.remove("on-green");
                ledBoyaOff.classList.add("on-red");
                txtBoya.innerText = "ESTADO: VACO";
                txtBoya.style.color = "#ff4444";
            }
        }

        // Funci贸n auxiliar para escribir en la consola negra
        function log(texto) {
            const hora = new Date().toLocaleTimeString();
            consoleLog.innerHTML = `> [${hora}] ${texto}<br>` + consoleLog.innerHTML;
        }

    </script>
</body>
</html>
